name: Build and Deploy to GitHub Pages

on:
  push:
    branches: [master, main]
    paths:
      - 'Phase-3/frontend/**'
      - '.github/workflows/deploy.yml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "Phase-3/frontend/package-lock.json"

      - name: Install dependencies
        working-directory: Phase-3/frontend
        run: npm ci

      - name: Clean build cache
        working-directory: Phase-3/frontend
        run: |
          rm -rf .next
          rm -rf out
          rm -rf node_modules/.cache
          rm -rf .turbo
          echo "âœ“ Build cache cleared"

      - name: Build
        working-directory: Phase-3/frontend
        env:
          NODE_ENV: production
        run: npm run build

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@example.com"
          git config --global user.name "GitHub Actions Bot"

      - name: Deploy to gh-pages branch
        run: |
          # Create a temporary directory for deployment
          mkdir -p /tmp/deploy
          cp -r Phase-3/frontend/out/* /tmp/deploy/
          touch /tmp/deploy/.nojekyll

          # Save current branch info
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

          # Check if gh-pages branch exists, if not create it
          if git show-ref --quiet refs/remotes/origin/gh-pages; then
            echo "âœ… gh-pages branch exists"
            git fetch origin gh-pages
            git checkout gh-pages
          else
            echo "ğŸ“ Creating gh-pages branch..."
            git checkout --orphan gh-pages
            git rm -rf .
          fi

          # Clean everything except .git
          find . -mindepth 1 -not -name '.git' -type f -delete
          find . -mindepth 1 -not -name '.git' -type d -exec rm -rf {} + 2>/dev/null || true

          # Copy deployment files
          cp -r /tmp/deploy/* .

          # Add and commit
          git add .
          git commit -m "ğŸš€ Deploy: GitHub Pages build from $(date -u +'%Y-%m-%d %H:%M:%S') UTC [skip ci]" || echo "âš ï¸ No changes to commit"

          # Push to gh-pages
          git push origin gh-pages -f

          echo "âœ… Deployed to gh-pages branch"

      - name: Show deployment info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT COMPLETE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ GitHub Pages URL:"
          echo "   https://hafiznaveedchuhan-ctrl.github.io/hackaton2pages/"
          echo ""
          echo "ğŸ“š Repository:"
          echo "   https://github.com/hafiznaveedchuhan-ctrl/hackaton2pages"
          echo ""
          echo "â±ï¸  It may take a few minutes for changes to appear"
          echo ""
